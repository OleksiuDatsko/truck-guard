openapi: 3.1.0
info:
  title: "TruckGuard API"
  version: "1.0.0"
  description: "TruckGuard vehicle tracking system - Microservices Documentation"
  x-logo-url: "https://truckguard.logo"

servers:
  - url: http://localhost:80
    description: Dev Gateway (Nginx)
  - url: https://api.truckguard.ua
    description: Production Gateway

tags:
  - name: Auth
    description: Public authentication endpoints
  - name: "Admin: Users"
    description: User management
  - name: "Core: Users"
    description: Core user profile management
  - name: "Admin: Roles"
    description: Role and permission management
  - name: "Admin: Keys"
    description: API Key management
  - name: "Hardware: Cameras"
    description: Camera discovery and config
  - name: "Hardware: Scales"
    description: Scale discovery and config
  - name: "Hardware: Gates"
  - name: "System: Settings"
    description: Global system settings
  - name: "System: Exclusions"
    description: Excluded plates management
  - name: "Events: Raw"
    description: Raw plate and weight events
  - name: "Events: System"
    description: System/Audit events
  - name: "Operations: Permits"
    description: Permit management
  - name: Ingestor
    description: Data ingestion
  - name: ANPR
    description: Recognition service
  - name: Health
    description: Health checks
  - name: "Core: Data"
    description: Master data management

security:
  - bearerAuth: []
  - apiKey: []

paths:
  # --- Auth Service ---
  /auth/login:
    post:
      tags: [Auth]
      summary: Login to the system
      description: Authenticate with username and password to receive a JWT.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [username, password]
              properties:
                username: { type: string }
                password: { type: string }
      responses:
        200:
          description: Successfully authenticated
          content:
            application/json:
              example: { token: "eyJhbG..." }
        401:
          $ref: "#/components/responses/Unauthorized"

  /auth/register:
    post:
      tags: [Auth]
      summary: Register a new user
      description: |
        Create a new user account.
        Permissions: `create:users`
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [username, password, role_id]
              properties:
                username: { type: string }
                password: { type: string }
                role_id: { type: integer }
      responses:
        201:
          description: User created
        403:
          $ref: "#/components/responses/Forbidden"

  /auth/validate:
    get:
      tags: [Auth]
      summary: Validate token or API Key
      description: Verification endpoint used by Gateway to check access.
      responses:
        200:
          description: Token is valid
        401:
          $ref: "#/components/responses/Unauthorized"

  # --- Core Service Users ---
  /api/users/by-auth-id/{authId}:
    get:
      tags: ["Core: Users"]
      summary: Get user profile by Auth ID
      description: |
        Retrieve Core user profile using the Authentication Service ID.
        Permissions: `read:users`
      parameters:
        - name: authId
          in: path
          required: true
          schema: { type: string }
      responses:
        200:
          description: User profile
          content:
            application/json:
              schema: { $ref: "#/components/schemas/User" }
        404:
          $ref: "#/components/responses/NotFound"

  # --- Auth Admin ---
  /auth/admin/users:
    get:
      tags: ["Admin: Users"]
      summary: List all users
      description: |
        List all users in the system.
        Permissions: `manage:settings`, `read:users`
      responses:
        200:
          description: List of users
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/User" }

  /auth/admin/users/{id}/role:
    put:
      tags: ["Admin: Users"]
      summary: Update user role
      description: |
        Update the role of a user.
        Permissions: `manage:settings`, `update:users`
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [role_id]
              properties:
                role_id: { type: integer }
      responses:
        200:
          description: Role updated

  /auth/admin/users/{id}:
    delete:
      tags: ["Admin: Users"]
      summary: Delete user
      description: |
        Permanently delete a user.
        Permissions: `manage:settings`, `delete:users`
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        204:
          description: User deleted

  /auth/admin/roles:
    get:
      tags: ["Admin: Roles"]
      summary: List all roles
      description: |
        List all user roles.
        Permissions: `manage:settings`, `read:roles`
      security: [{ bearerAuth: [] }]
      responses:
        200:
          description: List of roles
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Role" }
    post:
      tags: ["Admin: Roles"]
      summary: Create a new role
      description: |
        Create a new role with specific permissions.
        Permissions: `manage:settings`, `create:roles`
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/Role" }
      responses:
        201:
          description: Role created

  /auth/admin/roles/{id}:
    put:
      tags: ["Admin: Roles"]
      summary: Update role
      description: |
        Update role name or description.
        Permissions: `manage:settings`, `update:roles`
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/Role" }
      responses:
        200:
          description: Role updated
    delete:
      tags: ["Admin: Roles"]
      summary: Delete role
      description: |
        Permanently delete a role.
        Permissions: `manage:settings`, `delete:roles`
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        204:
          description: Role deleted

  /auth/admin/roles/{id}/permissions:
    post:
      tags: ["Admin: Roles"]
      summary: Assign permissions to role
      description: |
        Replace permissions assigned to a role.
        Permissions: `manage:settings`, `update:roles`
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema:
              type: array
              items: { type: string }
      responses:
        200:
          description: Permissions assigned

  /auth/admin/keys:
    get:
      tags: ["Admin: Keys"]
      summary: List API Keys
      description: |
        List all IoT API Keys.
        Permissions: `manage:settings`, `read:keys`
      security: [{ bearerAuth: [] }]
      responses:
        200:
          description: List of keys
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/APIKey" }
    post:
      tags: ["Admin: Keys"]
      summary: Create a new API Key
      description: |
        Create a new IoT API Key with permissions.
        Permissions: `manage:settings`, `create:keys`
      security: [{ bearerAuth: [] }]
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [owner_name, permissionIDs]
              properties:
                owner_name: { type: string }
                permissionIDs:
                  type: array
                  items: { type: string }
      responses:
        201:
          description: Key created
          content:
            application/json:
              example: { key: "tg_...", id: 5 }

  /auth/admin/keys/{id}:
    put:
      tags: ["Admin: Keys"]
      summary: Update API key
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                owner_name: { type: string }
                is_active: { type: boolean }
      responses:
        200:
          description: Key updated
    delete:
      tags: ["Admin: Keys"]
      summary: Delete API key
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        204:
          description: Key deleted

  /auth/admin/keys/{id}/permissions:
    put:
      tags: ["Admin: Keys"]
      summary: Assign permissions to key
      description: |
        Replace permissions assigned to an API Key.
        Permissions: `manage:settings`, `update:keys`
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema:
              type: array
              items: { type: string }
      responses:
        200:
          description: Permissions assigned

  /auth/admin/permissions:
    get:
      tags: ["Admin: Roles"]
      summary: List all permissions
      description: |
        List all available permissions in the system.
        Permissions: `manage:settings`, `read:roles`
      responses:
        200:
          description: List of permissions
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Permission" }

  # --- Core Service ---
  /api/cameras/by-id/{camera_id}:
    get:
      tags: ["Hardware: Cameras"]
      summary: Get camera config by Source ID
      description: Retrieve camera configuration by external Source ID.
      parameters:
        - name: camera_id
          in: path
          required: true
          schema: { type: string }
      responses:
        200:
          description: Camera config
          content:
            application/json:
              schema: { $ref: "#/components/schemas/CameraConfig" }

  /api/scales/by-id/{scale_id}:
    get:
      tags: ["Hardware: Scales"]
      summary: Get scale config by Source ID
      description: Retrieve scale configuration by external Source ID.
      parameters:
        - name: scale_id
          in: path
          required: true
          schema: { type: string }
      responses:
        200:
          description: Scale config
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ScaleConfig" }

  /api/configs/cameras:
    get:
      tags: ["Hardware: Cameras"]
      summary: List all cameras
      description: |
        List all registered cameras with pagination.
        Permissions: `manage:configs`, `read:cameras`
      parameters:
        - name: page
          in: query
          schema: { type: integer, default: 1 }
        - name: limit
          in: query
          schema: { type: integer, default: 10 }
      responses:
        200:
          description: List of cameras
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items: { $ref: "#/components/schemas/CameraConfig" }
                  metadata: { $ref: "#/components/schemas/PaginationMetadata" }
    post:
      tags: ["Hardware: Cameras"]
      summary: Register a new camera
      description: |
        Create a camera and automatically provision an API Key.
        Permissions: `manage:configs`, `create:cameras`, `create:keys`
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CameraConfig" }
      responses:
        201:
          description: Camera registered

  /api/configs/cameras/{id}:
    get:
      tags: ["Hardware: Cameras"]
      summary: Get camera config by ID
      description: |
        Retrieve camera configuration by internal database ID.
        Permissions: `manage:configs`, `read:cameras`
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        200:
          description: Camera config
          content:
            application/json:
              schema: { $ref: "#/components/schemas/CameraConfig" }
        404:
          $ref: "#/components/responses/NotFound"
    put:
      tags: ["Hardware: Cameras"]
      summary: Update camera config
      description: |
        Update existing camera configuration.
        Permissions: `manage:configs`, `update:cameras`
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CameraConfig" }
      responses:
        200:
          description: Camera updated
    delete:
      tags: ["Hardware: Cameras"]
      summary: Delete camera config
      description: |
        Permanently delete camera configuration.
        Permissions: `manage:configs`, `delete:cameras`
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        204:
          description: Camera deleted

  /api/configs/scales:
    get:
      tags: ["Hardware: Scales"]
      summary: List all scales
      description: |
        List all registered weight scales with pagination.
        Permissions: `manage:configs`, `read:scales`
      parameters:
        - name: page
          in: query
          schema: { type: integer, default: 1 }
        - name: limit
          in: query
          schema: { type: integer, default: 10 }
      responses:
        200:
          description: List of scales
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items: { $ref: "#/components/schemas/ScaleConfig" }
                  metadata: { $ref: "#/components/schemas/PaginationMetadata" }
    post:
      tags: ["Hardware: Scales"]
      summary: Register a new scale
      description: |
        Create a scale configuration and automatically provision an API Key.
        Permissions: `manage:configs`, `create:scales`, `create:keys`
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/ScaleConfig" }
      responses:
        201:
          description: Scale registered

  /api/configs/scales/{id}:
    put:
      tags: ["Hardware: Scales"]
      summary: Update scale config
      description: |
        Update existing scale configuration.
        Permissions: `manage:configs`, `update:scales`
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/ScaleConfig" }
      responses:
        200:
          description: Scale updated
    delete:
      tags: ["Hardware: Scales"]
      summary: Delete scale config
      description: |
        Permanently delete scale configuration.
        Permissions: `manage:configs`, `delete:scales`
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        204:
          description: Scale deleted

  /api/configs/settings:
    get:
      tags: ["System: Settings"]
      summary: List system settings
      description: |
        List all global system settings.
        Permissions: `read:settings`
      responses:
        200:
          description: List of settings
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/SystemSetting" }
    post:
      tags: ["System: Settings"]
      summary: Update system setting
      description: |
        Update or create a system setting (e.g., match_window_seconds).
        Permissions: `update:settings`
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/SystemSetting" }
      responses:
        200:
          description: Setting updated

  /api/configs/excluded-plates:
    get:
      tags: ["System: Exclusions"]
      summary: List excluded plates
      description: |
        List all license plates in the ignore list.
        Permissions: `read:excluded_plates`
      responses:
        200:
          description: List of plates
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/ExcludedPlate" }
    post:
      tags: ["System: Exclusions"]
      summary: Add plate to ignore list
      description: |
        Add a plate to the exclusion list.
        Permissions: `create:excluded_plates`
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/ExcludedPlate" }
      responses:
        201:
          description: Plate added

  /api/configs/excluded-plates/{id}:
    delete:
      tags: ["System: Exclusions"]
      summary: Remove plate from ignore list
      description: |
        Remove a plate from the exclusion list by ID.
        Permissions: `delete:excluded_plates`
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        204:
          description: Plate removed

  /api/events/plate:
    get:
      tags: ["Events: Raw"]
      summary: List plate recognition events
      description: |
        List all plate events with pagination.
        Permissions: `read:events`
      parameters:
        - name: page
          in: query
          schema: { type: integer, default: 1 }
        - name: limit
          in: query
          schema: { type: integer, default: 10 }
      responses:
        200:
          description: List of events
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items: { $ref: "#/components/schemas/RawPlateEvent" }
                  metadata: { $ref: "#/components/schemas/PaginationMetadata" }
    post:
      tags: ["Events: Raw"]
      summary: Submit a plate recognition event
      description: |
        Submit a new plate recognition event.
        Permissions: `create:events`
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/RawPlateEvent" }
      responses:
        202:
          description: Event accepted for processing
          content:
            application/json:
              example: { status: "processing", message: "Event queued" }

  /api/events/plate/{id}:
    get:
      tags: ["Events: Raw"]
      summary: Get plate event by ID
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        200:
          description: Event details
          content:
            application/json:
              schema: { $ref: "#/components/schemas/RawPlateEvent" }
        404:
          $ref: "#/components/responses/NotFound"
    patch:
      tags: ["Events: Raw"]
      summary: Correct plate recognition result
      description: |
        Correct the plate number and tracks the user who performed the correction.
        Permissions: `update:events`
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [plate_corrected]
              properties:
                plate_corrected: { type: string }
      responses:
        200:
          description: Event corrected
          content:
            application/json:
              schema: { $ref: "#/components/schemas/RawPlateEvent" }

  /api/events/weight:
    get:
      tags: ["Events: Raw"]
      summary: List weight events
      description: |
        List all weight events with pagination.
        Permissions: `read:events`
      parameters:
        - name: page
          in: query
          schema: { type: integer, default: 1 }
        - name: limit
          in: query
          schema: { type: integer, default: 10 }
      responses:
        200:
          description: List of weight events
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items: { $ref: "#/components/schemas/RawWeightEvent" }
                  metadata: { $ref: "#/components/schemas/PaginationMetadata" }
    post:
      tags: ["Events: Raw"]
      summary: Submit a weight scale event
      description: |
        Submit a new weight event from a scale.
        Permissions: `create:events`
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/RawWeightEvent" }
      responses:
        202:
          description: Event accepted

  /api/events/weight/{id}:
    get:
      tags: ["Events: Raw"]
      summary: Get weight event by ID
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        200:
          description: Weight event details
          content:
            application/json:
              schema: { $ref: "#/components/schemas/RawWeightEvent" }
        404:
          $ref: "#/components/responses/NotFound"

  /api/events/system:
    get:
      tags: ["Events: System"]
      summary: List system events
      description: |
        List all system events (audit log).
        Permissions: `read:events`
      parameters:
        - name: page
          in: query
          schema: { type: integer, default: 1 }
        - name: limit
          in: query
          schema: { type: integer, default: 10 }
      responses:
        200:
          description: List of system events
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items: { $ref: "#/components/schemas/SystemEvent" }
                  metadata: { $ref: "#/components/schemas/PaginationMetadata" }

  /api/events/system/{id}:
    get:
      tags: ["Events: System"]
      summary: Get system event by ID
      description: |
        Retrieve system event details.
        Permissions: `read:events`
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        200:
          description: System event details
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SystemEvent" }
        404:
          $ref: "#/components/responses/NotFound"

  /api/permits:
    get:
      tags: ["Operations: Permits"]
      summary: List all permits
      description: |
        List all vehicle permits (correlated passes) with pagination and filtering.
        Permissions: `read:permits`, `read:permits:all`
      parameters:
        - name: page
          in: query
          schema: { type: integer, default: 1 }
        - name: limit
          in: query
          schema: { type: integer, default: 10 }
        - name: plate
          in: query
          description: Filter permits by license plate (exact match on front or back)
          schema: { type: string }
      responses:
        200:
          description: List of permits
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items: { $ref: "#/components/schemas/Permit" }
                  metadata: { $ref: "#/components/schemas/PaginationMetadata" }
    post:
      tags: ["Operations: Permits"]
      summary: Create a new permit manually
      description: |
        Create a new permit without a pre-existing gate event.
        Permissions: `create:permits`
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/Permit" }
      responses:
        201:
          description: Permit created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Permit" }

  /api/permits/{id}:
    get:
      tags: ["Operations: Permits"]
      summary: Get permit by ID
      description: |
        Retrieve detailed vehicle permit with image links.
        Permissions: `read:permits`, `read:permits:all`
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        200:
          description: Permit details
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Permit" }
        404:
          $ref: "#/components/responses/NotFound"
    put:
      tags: ["Operations: Permits"]
      summary: Update permit
      description: |
        Update permit details. Verification logic is triggered here.
        Permissions: `update:permits`
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/Permit" }
      responses:
        200:
          description: Permit updated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Permit" }

  # --- Core: Users ---
  /api/users:
    get:
      tags: ["Core: Users"]
      summary: List all user profiles
      description: |
        List all user profiles stored in the Core service.
        Permissions: `read:users`
      responses:
        200:
          description: List of user profiles
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/UserCore" }

  /api/users/me:
    get:
      tags: ["Core: Users"]
      summary: Get current user profile
      responses:
        200:
          description: User profile
          content:
            application/json:
              schema: { $ref: "#/components/schemas/UserCore" }
    put:
      tags: ["Core: Users"]
      summary: Update current user profile
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                first_name: { type: string }
                last_name: { type: string }
                third_name: { type: string }
                phone_number: { type: string }
                email: { type: string }
                notes: { type: string }
                customs_post_id: { type: integer, nullable: true }
      responses:
        200:
          description: User updated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/UserCore" }

  /api/users/{id}:
    get:
      tags: ["Core: Users"]
      summary: Get user profile
      description: |
        Get user profile by Auth ID.
        Permissions: `read:users`
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        200:
          description: User profile
          content:
            application/json:
              schema: { $ref: "#/components/schemas/UserCore" }
        404:
          $ref: "#/components/responses/NotFound"
    put:
      tags: ["Core: Users"]
      summary: Update user profile
      description: |
        Update user profile details.
        Permissions: `update:users`
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                first_name: { type: string }
                last_name: { type: string }
                third_name: { type: string }
                phone_number: { type: string }
                email: { type: string }
                notes: { type: string }
                customs_post_id: { type: integer, nullable: true }
      responses:
        200:
          description: User updated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/UserCore" }
    delete:
      tags: ["Core: Users"]
      summary: Delete user
      description: |
        Delete user profile and account (from Core and Auth).
        Permissions: `delete:users`
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        200:
          description: User and account deleted

  # --- Ingestor Service ---
  /ingest/camera:
    post:
      tags: [Ingestor]
      summary: Ingest raw camera data
      description: |
        Endpoint for cameras to upload images and metadata.
        Permissions: `create:ingest`
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              required: [image, device_id]
              properties:
                image:
                  type: string
                  format: binary
                device_id: { type: string }
                payload:
                  type: string
                  description: JSON or XML string depending on device
      responses:
        202:
          description: Data ingested successfully
          content:
            application/json:
              schema: { $ref: "#/components/schemas/IngestEvent" }

  /ingest/weight:
    post:
      tags: [Ingestor]
      summary: Ingest raw weight data
      description: |
        Endpoint for scales to upload weight data.
        Permissions: `create:ingest`
      requestBody:
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required: [device_id]
              properties:
                device_id: { type: string }
                payload:
                  type: string
                  description: JSON payload with weight data
      responses:
        202:
          description: Data ingested successfully
          content:
            application/json:
              schema: { $ref: "#/components/schemas/IngestEvent" }

  # --- ANPR Service ---
  /anpr/recognize:
    post:
      tags: [ANPR]
      summary: Recognize license plate from image
      description: Forward image to ANPR engine for recognition.
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              required: [image]
              properties:
                image:
                  type: string
                  format: binary
      responses:
        200:
          description: Recognition result
          content:
            application/json:
              example: { plate: "AA1234BB", confidence: 0.98 }

  # --- Data Service ---
  /api/data/posts:
    get:
      tags: ["Data"]
      summary: List customs posts
      parameters:
        - name: name
          in: query
          schema: { type: string }
      responses:
        200:
          description: List of posts
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/CustomsPost" }
    post:
      tags: ["Data"]
      summary: Create customs post
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CustomsPost" }
      responses:
        201:
          description: Created

  /api/data/posts/{id}:
    put:
      tags: ["Data"]
      summary: Update customs post
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CustomsPost" }
      responses:
        200:
          description: Updated
    delete:
      tags: ["Data"]
      summary: Delete customs post
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        204:
          description: Deleted

  /api/data/modes:
    get:
      tags: ["Data"]
      summary: List customs modes
      parameters:
        - name: code
          in: query
          schema: { type: string }
        - name: name
          in: query
          schema: { type: string }
      responses:
        200:
          description: List of modes
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/CustomsMode" }
    post:
      tags: ["Data"]
      summary: Create customs mode
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CustomsMode" }
      responses:
        201:
          description: Created

  /api/data/modes/{id}:
    put:
      tags: ["Data"]
      summary: Update customs mode
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CustomsMode" }
      responses:
        200:
          description: Updated
    delete:
      tags: ["Data"]
      summary: Delete customs mode
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        204:
          description: Deleted

  /api/data/vehicle-types:
    get:
      tags: ["Data"]
      summary: List vehicle types
      parameters:
        - name: code
          in: query
          schema: { type: string }
        - name: name
          in: query
          schema: { type: string }
      responses:
        200:
          description: List of vehicle types
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/VehicleType" }
    post:
      tags: ["Core: Data"]
      summary: Create vehicle type
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/VehicleType" }
      responses:
        201:
          description: Created

  /api/data/vehicle-types/{id}:
    put:
      tags: ["Core: Data"]
      summary: Update vehicle type
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/VehicleType" }
      responses:
        200:
          description: Updated
    delete:
      tags: ["Core: Data"]
      summary: Delete vehicle type
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        204:
          description: Deleted

  /api/data/payment-types:
    get:
      tags: ["Core: Data"]
      summary: List payment types
      parameters:
        - name: code
          in: query
          schema: { type: string }
        - name: is_active
          in: query
          schema: { type: boolean }
      responses:
        200:
          description: List of payment types
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/PaymentType" }
    post:
      tags: ["Core: Data"]
      summary: Create payment type
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/PaymentType" }
      responses:
        201:
          description: Created

  /api/data/payment-types/{id}:
    put:
      tags: ["Core: Data"]
      summary: Update payment type
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/PaymentType" }
      responses:
        200:
          description: Updated
    delete:
      tags: ["Core: Data"]
      summary: Delete payment type
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        204:
          description: Deleted

  /api/data/companies:
    get:
      tags: ["Core: Data"]
      summary: List companies
      parameters:
        - name: edrpou
          in: query
          schema: { type: string }
        - name: name
          in: query
          schema: { type: string }
      responses:
        200:
          description: List of companies
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Company" }
    post:
      tags: ["Core: Data"]
      summary: Create company
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/Company" }
      responses:
        201:
          description: Created

  /api/data/companies/{id}:
    put:
      tags: ["Core: Data"]
      summary: Update company
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/Company" }
      responses:
        200:
          description: Updated
    delete:
      tags: ["Core: Data"]
      summary: Delete company
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        204:
          description: Deleted

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    apiKey:
      type: apiKey
      in: header
      name: X-API-Key

  responses:
    Unauthorized:
      description: Unauthorized - Invalid or missing credentials
      content:
        application/json:
          example: { error: "unauthorized" }
    Forbidden:
      description: Forbidden - Insufficient permissions
    NotFound:
      description: Resource not found
    InternalError:
      description: Internal Server Error

  schemas:
    User:
      type: object
      properties:
        id: { type: integer }
        username: { type: string }
        role_id: { type: integer }
        role: { $ref: "#/components/schemas/Role" }
        created_at: { type: string, format: date-time }

    UserCore:
      type: object
      properties:
        id: { type: integer }
        auth_id: { type: integer }
        first_name: { type: string }
        last_name: { type: string }
        third_name: { type: string }
        phone_number: { type: string }
        email: { type: string }
        notes: { type: string }
        role: { type: string }
        customs_post_id: { type: integer, nullable: true }
        customs_post: { $ref: "#/components/schemas/CustomsPost" }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }

    Role:
      type: object
      required: [name]
      properties:
        id: { type: integer }
        name: { type: string }
        description: { type: string }
        permissions:
          type: array
          items: { $ref: "#/components/schemas/Permission" }

    Permission:
      type: object
      properties:
        id: { type: string }
        name: { type: string }
        description: { type: string }
        module: { type: string }

    APIKey:
      type: object
      properties:
        id: { type: integer }
        owner_name: { type: string }
        is_active: { type: boolean }
        permissions:
          type: array
          items: { $ref: "#/components/schemas/Permission" }
        created_at: { type: string, format: date-time }

    CameraConfig:
      type: object
      required: [camera_id, name, format]
      properties:
        id: { type: integer }
        camera_id: { type: string, description: "Source Identification String" }
        name: { type: string }
        description: { type: string }
        type: { type: string, enum: [front, back] }
        format:
          type: string
          enum: [xml, json]
        run_anpr: { type: boolean }
        trigger_permit_creation:
          {
            type: boolean,
            description: "Whether events from this camera should trigger a new permit creation",
          }
        field_mapping:
          { type: string, description: "JSON mapping for payload fields" }
        customs_post_id: { type: integer, nullable: true }
        customs_post: { $ref: "#/components/schemas/CustomsPost" }

    SystemSetting:
      type: object
      required: [key, value]
      properties:
        id: { type: integer }
        key: { type: string }
        value: { type: string }

    ExcludedPlate:
      type: object
      required: [plate]
      properties:
        id: { type: integer }
        plate: { type: string }
        comment: { type: string }

    Permit:
      type: object
      properties:
        id: { type: integer }
        code: { type: string }
        is_closed: { type: boolean }
        is_void: { type: boolean }
        customs_post_id: { type: integer, nullable: true }
        customs_post: { $ref: "#/components/schemas/CustomsPost" }
        declaration_number: { type: string }
        customs_mode_code: { type: string }
        customs_mode: { $ref: "#/components/schemas/CustomsMode" }
        notes: { type: string }
        vehicle_type_id: { type: integer, nullable: true }
        vehicle_type: { $ref: "#/components/schemas/VehicleType" }
        plate_front: { type: string }
        plate_back: { type: string }
        total_weight: { type: number }
        payment_type_id: { type: integer, nullable: true }
        payment_type: { $ref: "#/components/schemas/PaymentType" }
        entry_fee: { type: number }
        exit_fee: { type: number }
        payers:
          type: array
          items: { $ref: "#/components/schemas/PermitPayer" }
        entry_time: { type: string, format: date-time }
        exit_time: { type: string, format: date-time, nullable: true }
        last_activity_at: { type: string, format: date-time }
        created_by: { type: integer, nullable: true }
        verified_by: { type: integer, nullable: true }
        verified_at: { type: string, format: date-time, nullable: true }
        responsible_user_id: { type: integer, nullable: true }
        plate_events:
          type: array
          items: { $ref: "#/components/schemas/RawPlateEvent" }
        weight_events:
          type: array
          items: { $ref: "#/components/schemas/RawWeightEvent" }
        audit_events:
          type: array
          items: { $ref: "#/components/schemas/PermitAudit" }

    ScaleConfig:
      type: object
      required: [scale_id, name, format]
      properties:
        id: { type: integer }
        scale_id: { type: string, description: "Source Identification String" }
        name: { type: string }
        description: { type: string }
        format:
          type: string
          enum: [xml, json]
        trigger_permit_creation:
          {
            type: boolean,
            description: "Whether events from this scale should trigger a new permit creation",
          }
        field_mapping:
          { type: string, description: "JSON mapping for payload fields" }
        customs_post_id: { type: integer, nullable: true }
        customs_post: { $ref: "#/components/schemas/CustomsPost" }

    RawPlateEvent:
      type: object
      required: [camera_id, plate, timestamp]
      properties:
        id: { type: integer }
        camera_id: { type: string, description: "Internal SourceID" }
        camera_source_id: { type: string, description: "Raw device SourceID" }
        camera_source_name: { type: string }
        plate: { type: string }
        plate_corrected: { type: string }
        corrected_by: { type: string }
        is_manual: { type: boolean }
        image_key: { type: string }
        timestamp: { type: string, format: date-time }
        suggestions:
          { type: object, description: "JSONB suggestions from ANPR" }
        system_event_id: { type: integer }
        permit_id: { type: integer, nullable: true }

    RawWeightEvent:
      type: object
      required: [scale_id, weight, timestamp]
      properties:
        id: { type: integer }
        scale_id: { type: string }
        scale_source_id: { type: string }
        weight: { type: number, format: float }
        timestamp: { type: string, format: date-time }
        system_event_id: { type: integer }
        permit_id: { type: integer, nullable: true }

    SystemEvent:
      type: object
      properties:
        id: { type: integer }
        type: { type: string }
        source_id: { type: string }
        payload: { type: string }
        timestamp: { type: string, format: date-time }

    IngestEvent:
      type: object
      properties:
        type: { type: string }
        source_id: { type: string }
        source_name: { type: string }
        device_id: { type: string }
        image_key: { type: string }
        payload: { type: string }
    PaginationMetadata:
      type: object
      properties:
        total_items: { type: integer }
        total_pages: { type: integer }
        current_page: { type: integer }
        limit: { type: integer }

    CustomsPost:
      type: object
      required: [name]
      properties:
        id: { type: integer }
        name: { type: string }
        description: { type: string }
        cameras:
          type: array
          items: { $ref: "#/components/schemas/CameraConfig" }
        scales:
          type: array
          items: { $ref: "#/components/schemas/ScaleConfig" }

    CustomsMode:
      type: object
      required: [name, code]
      properties:
        id: { type: integer }
        name: { type: string }
        code: { type: string }
        description: { type: string }

    Company:
      type: object
      required: [name, edrpou]
      properties:
        id: { type: integer }
        name: { type: string }
        edrpou: { type: string }
        details: { type: object }
        last_synced_at: { type: string, format: date-time }

    VehicleType:
      type: object
      required: [name, code]
      properties:
        id: { type: integer }
        name: { type: string }
        code: { type: string }
        description: { type: string }
        entry_price: { type: number }
        daily_price: { type: number }
        color: { type: string }

    PaymentType:
      type: object
      required: [name, code]
      properties:
        id: { type: integer }
        name: { type: string }
        code: { type: string }
        description: { type: string }
        is_active: { type: boolean }
        icon: { type: string }

    PermitPayer:
      type: object
      properties:
        id: { type: integer }
        permit_id: { type: integer }
        company_id: { type: integer }
        company: { $ref: "#/components/schemas/Company" }
        slot_index: { type: integer }

    PermitAudit:
      type: object
      properties:
        id: { type: integer }
        permit_id: { type: integer }
        user_id: { type: integer }
        action: { type: string }
        changes: { type: object }
        comment: { type: string }
        created_at: { type: string, format: date-time }
